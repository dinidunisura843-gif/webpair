<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.0.0-alpha.1/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script>
  const pairOutput = document.getElementById("pair");
  const submitBtn = document.getElementById("submit");
  const numberInput = document.getElementById("number");
  const spinner = document.getElementById("loading-spinner");

  async function Copy() {
    const copyElement = document.getElementById("copy");
    const originalText = copyElement.innerText;
    const textToCopy = originalText.replace('CODE: ', '');
    await navigator.clipboard.writeText(textToCopy);
    copyElement.innerText = "✔️ COPIED";
    copyElement.style.color = "red";
    copyElement.style.fontWeight = "bold";

    setTimeout(() => {
      copyElement.innerText = originalText;
      copyElement.style.color = "white";
      copyElement.style.fontWeight = "bold";
    }, 500);
  }

  submitBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    pairOutput.innerHTML = '';
    const rawInput = numberInput.value.replace(/[^0-9]/g, "");

    if (!rawInput) {
      pairOutput.innerHTML = '<div style="color:white;font-weight:bold">❗ Enter your WhatsApp number with country code.</div>';
      return;
    }

    if (rawInput.length < 11) {
      pairOutput.innerHTML = '<div style="color:white;font-weight:bold">❗ Invalid number format. Please try again.</div>';
      return;
    }

    const formatted = "+" + rawInput.replace(/(\d{3})(\d{5})(\d{3})/, "$1 $2 $3");
    numberInput.type = "text";
    numberInput.value = formatted;
    numberInput.style.color = "white";
    numberInput.style.fontSize = "20px";

    spinner.style.display = "block";

    try {
      const { data } = await axios(`/code?number=${rawInput}`);
      const code = data.code || "❗ Service Unavailable";

      pairOutput.innerHTML = `
        <font id="copy" onclick="Copy()" style="color:red;font-weight:bold; cursor: pointer;" size="5">
          CODE: <span style="color:white;font-weight:bold">${code}</span>
        </font>
        <br><br>
        <canvas id="qr-code"></canvas>
        <br>
      `;

      // Generate QR
      const canvas = document.getElementById("qr-code");
      await QRCode.toCanvas(canvas, code, {
        color: {
          dark: '#ffffff',
          light: '#141414'
        },
        width: 200
      });

    } catch (err) {
      pairOutput.innerHTML = '<div style="color:red;font-weight:bold">❗ Failed to get pair code. Please try again.</div>';
    } finally {
      spinner.style.display = "none";
    }
  });
</script>
